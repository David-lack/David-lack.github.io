<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Maths Battle Arena</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
  body {margin:0;padding:0;font-family:'Segoe UI',Arial,sans-serif;background:linear-gradient(135deg,#283e51 0%,#485563 100%);min-height:100vh;color:#ffd700;}
  #main-content{display:flex;flex-direction:column;align-items:center;padding-top:20px;}
  .card{background:rgba(255,255,255,0.04);box-shadow:0 8px 32px 0 rgba(44,62,80,0.15);border-radius:24px;padding:32px 34px;margin:16px auto;width:370px;max-width:95vw;display:flex;flex-direction:column;align-items:center;backdrop-filter: blur(8px);}
  h1{font-size:2.2em;margin-bottom:22px;letter-spacing:2px;text-shadow:0 2px 8px #222;}
  input,button,select{margin:7px 0;padding:11px;font-size:1em;border-radius:6px;border:1px solid #888;background:#2c3e50;color:#ffd700;width:100%;max-width:270px;box-sizing:border-box;}
  button{font-weight:bold;cursor:pointer;transition:0.2s;}
  button:hover{background:#ffd700;color:#222;}
  .hidden{display:none !important;}
  .battle-card{width:100%;background:rgba(44,62,80,0.18);border-radius:16px;padding:24px 16px 14px 16px;margin-top:16px;}
  #math-problem{font-size:1.2em;margin:12px 0;color:#fff;background:#232526;border-radius:8px;padding:12px 17px;text-align:center;letter-spacing:0.7px;}
  #player-health,#npc-health{height:18px;border-radius:9px;transition:width 0.33s;}
  #player-health{background:linear-gradient(90deg,#e74c3c 0%,#f1c40f 100%);}
  #npc-health{background:linear-gradient(90deg,#3498db 0%,#8e44ad 100%);}
  .bars{display:flex;justify-content:space-between;gap:16px;width:100%;margin:12px 0;}
  .bar{flex:1 1 0;display:flex;flex-direction:column;align-items:center;}
  .bar-bg{background:#222c;width:100%;overflow:hidden;border-radius:9px;margin-top:3px;}
  .battle-message{min-height:28px;font-size:1.15em;margin:8px 0 2px 0;text-shadow:0 1px 6px #222;white-space:pre-line;text-align:center;}
  table{width:100%;color:#ffd700;border-collapse:collapse;margin-top:10px;}
  th,td{border:1px solid #888;padding:6px;text-align:center;}
  th{background:#2c3e50;}
</style>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
</head>
<body>
<div id="main-content">
  <!-- AUTH SECTION -->
  <div id="auth-section" class="card">
    <h1>Maths Battle Arena</h1>
    <button id="show-signin">Sign In</button>
    <button id="show-signup">Create Account</button>
    <form id="signin-form" class="hidden" onsubmit="return false;">
      <input type="text" id="signin-username" placeholder="Username">
      <input type="password" id="signin-password" placeholder="Password">
      <button id="signin-btn">Sign In</button>
      <div id="signin-error"></div>
    </form>
    <form id="signup-form" class="hidden" onsubmit="return false;">
      <input type="text" id="signup-username" placeholder="Username">
      <input type="password" id="signup-password" placeholder="Password">
      <button id="signup-btn">Create Account</button>
      <div id="signup-error"></div>
    </form>
  </div>

  <!-- GAME SECTION -->
  <div id="game-section" class="card hidden">
    <h1>Maths Battle Arena</h1>
    <div class="bars">
      <div class="bar">Player HP<div class="bar-bg"><div id="player-health"></div></div></div>
      <div class="bar">NPC HP<div class="bar-bg"><div id="npc-health"></div></div></div>
    </div>
    <div id="math-problem"></div>
    <input type="text" id="answer-input" placeholder="Your Answer">
    <select id="difficulty">
      <option value="Easy">Easy</option>
      <option value="Medium">Medium</option>
      <option value="Hard">Hard</option>
    </select>
    <button id="start-battle">Start Battle?</button>
    <div class="battle-message" id="battle-message"></div>
    <button id="logout-btn">Logout</button>
  </div>

  <!-- LEADERBOARD -->
  <div id="leaderboard-section" class="card hidden">
    <h1>Leaderboard</h1>
    <button id="toggle-leaderboard">Hide/Show Leaderboard</button>
    <table id="leaderboard-table">
      <thead><tr><th>Username</th><th>Score</th></tr></thead>
      <tbody id="leaderboard-body"></tbody>
    </table>
    <button id="reset-leaderboard">Reset Leaderboard</button>
  </div>

  <!-- ADMIN PANEL -->
  <div id="admin-section" class="card hidden">
    <h1>Admin Panel</h1>
    <button id="refresh-users">Refresh User List</button>
    <table>
      <thead><tr><th>Username</th><th>Password</th><th>Actions</th></tr></thead>
      <tbody id="user-list"></tbody>
    </table>
    <input type="text" id="broadcast-message" placeholder="Broadcast message">
    <button id="send-broadcast">Send Broadcast</button>
    <button id="logout-admin">Logout</button>
  </div>
</div>

<script>
  // Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyC2PqmEQE5JnupeQkhGJ_kWVts80eWtnUA",
    authDomain: "pizza-f6116.firebaseapp.com",
    databaseURL: "https://pizza-f6116-default-rtdb.firebaseio.com",
    projectId: "pizza-f6116",
    storageBucket: "pizza-f6116.appspot.com",
    messagingSenderId: "219234227309",
    appId: "1:219234227309:web:d4dc436930ad9b9898db64"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  // UI
  const authSection=document.getElementById('auth-section');
  const signinForm=document.getElementById('signin-form');
  const signupForm=document.getElementById('signup-form');
  const showSignin=document.getElementById('show-signin');
  const showSignup=document.getElementById('show-signup');
  const signinBtn=document.getElementById('signin-btn');
  const signupBtn=document.getElementById('signup-btn');
  const signinError=document.getElementById('signin-error');
  const signupError=document.getElementById('signup-error');

  const gameSection=document.getElementById('game-section');
  const playerHealthBar=document.getElementById('player-health');
  const npcHealthBar=document.getElementById('npc-health');
  const mathProblem=document.getElementById('math-problem');
  const answerInput=document.getElementById('answer-input');
  const submitAnswer=document.getElementById('submit-answer');
  const battleMessage=document.getElementById('battle-message');
  const logoutBtn=document.getElementById('logout-btn');
  const startBattleBtn=document.getElementById('start-battle');
  const difficultySelect=document.getElementById('difficulty');

  const leaderboardSection=document.getElementById('leaderboard-section');
  const leaderboardBody=document.getElementById('leaderboard-body');
  const toggleLeaderboardBtn=document.getElementById('toggle-leaderboard');
  const resetLeaderboardBtn=document.getElementById('reset-leaderboard');

  const adminSection=document.getElementById('admin-section');
  const userListBody=document.getElementById('user-list');
  const refreshUsersBtn=document.getElementById('refresh-users');
  const broadcastInput=document.getElementById('broadcast-message');
  const sendBroadcastBtn=document.getElementById('send-broadcast');
  const logoutAdminBtn=document.getElementById('logout-admin');

  showSignup.onclick=()=>{signupForm.classList.remove('hidden');signinForm.classList.add('hidden');signupError.textContent='';signinError.textContent='';};
  showSignin.onclick=()=>{signinForm.classList.remove('hidden');signupForm.classList.add('hidden');signupError.textContent='';signinError.textContent='';};

  let currentUser=null,currentUserData=null,playerHP=100,npcHP=100,currentAnswer=null;

  // Ensure owner exists
  function ensureOwner(){
    const ownerRef=db.ref('users/David_lack');
    ownerRef.once('value').then(snap=>{
      if(!snap.exists()) ownerRef.set({password:"David@123",owner:true,admin:true,score:0});
      else ownerRef.update({password:"David@123",owner:true,admin:true});
    });
  }
  ensureOwner();

  // Signup
  signupBtn.onclick=()=>{
    const username=document.getElementById('signup-username').value.trim();
    const password=document.getElementById('signup-password').value;
    if(!username||!password){signupError.textContent="All fields required!";return;}
    db.ref('users/'+username).get().then(snap=>{
      if(snap.exists()){signupError.textContent="Username exists!";return;}
      db.ref('users/'+username).set({password,owner:false,admin:false,score:0});
      currentUser=username;
      currentUserData={password,owner:false,admin:false,score:0};
      afterLogin();
    });
  };

  // Signin
  signinBtn.onclick=()=>{
    const username=document.getElementById('signin-username').value.trim();
    const password=document.getElementById('signin-password').value;
    if(!username||!password){signinError.textContent="All fields required!";return;}
    db.ref('users/'+username).get().then(snap=>{
      if(!snap.exists()){signinError.textContent="Invalid username!";return;}
      const data=snap.val();
      if(data.password!==password){signinError.textContent="Wrong password!";return;}
      currentUser=username; currentUserData=data;
      afterLogin();
    });
  };

  // Logout
  logoutBtn.onclick=logoutAdminBtn.onclick=()=>{
    currentUser=null; currentUserData=null;
    authSection.classList.remove('hidden');
    gameSection.classList.add('hidden');
    leaderboardSection.classList.add('hidden');
    adminSection.classList.add('hidden');
    battleMessage.textContent='';
    mathProblem.textContent='';
  };

  function afterLogin(){
    authSection.classList.add('hidden');
    gameSection.classList.remove('hidden');
    leaderboardSection.classList.remove('hidden');
    if(currentUserData.admin || currentUserData.owner) adminSection.classList.remove('hidden');
    playerHP=100; npcHP=100; updateBars(); generateProblem();
    loadLeaderboard(); if(currentUserData.admin) loadUsers();
  }

  // Game logic
  function updateBars(){playerHealthBar.style.width=playerHP+"%";npcHealthBar.style.width=npcHP+"%";}
  function generateProblem(){
    const a=Math.floor(Math.random()*20+1),b=Math.floor(Math.random()*20+1);
    currentAnswer=a+b;
    mathProblem.textContent=`${a} + ${b} = ?`;
  }

  startBattleBtn.onclick=()=>{
    playerHP=100; npcHP=100; updateBars(); generateProblem(); battleMessage.textContent='Battle started!';
  };

  submitAnswer?.addEventListener('click',()=>{
    const ans=Number(answerInput.value);
    if(ans===currentAnswer){npcHP=Math.max(0,npcHP-10);battleMessage.textContent="Correct! You hit NPC!";currentUserData.score+=10;}
    else{playerHP=Math.max(0,playerHP-10);battleMessage.textContent="Wrong! NPC hits you!";}
    updateBars(); answerInput.value=""; generateProblem();
    if(playerHP===0||npcHP===0){battleMessage.textContent=playerHP>npcHP?"You Won!":"You Lost!"; syncScore();}
  });

  function syncScore(){db.ref('users/'+currentUser+'/score').set(currentUserData.score); loadLeaderboard();}

  // Leaderboard
  function loadLeaderboard(){
    db.ref('users').orderByChild('score').limitToLast(10).get().then(snap=>{
      const arr=[];
      snap.forEach(c=>arr.push({user:c.key,score:c.val().score||0}));
      arr.reverse();
      leaderboardBody.innerHTML=arr.length?arr.map(u=>`<tr><td>${u.user}</td><td>${u.score}</td>`).join(''):`<tr><td colspan="2">No one on top. Be the First person to be on top of the leaderboard!</td></tr>`;
    });
  }

  toggleLeaderboardBtn.onclick=()=>leaderboardSection.classList.toggle('hidden');
  resetLeaderboardBtn.onclick=()=>{
    if(confirm("Reset leaderboard?")) db.ref('users').get().then(snap=>snap.forEach(c=>db.ref('users/'+c.key+'/score').set(0)));
    loadLeaderboard();
  };

  // Admin functions
  function loadUsers(){
    db.ref('users').get().then(snap=>{
      userListBody.innerHTML='';
      snap.forEach(c=>{
        const data=c.val();
        const tr=document.createElement('tr');
        tr.innerHTML=`<td>${c.key}</td><td>${data.password}</td>
        <td>
          <button onclick="resetPass('${c.key}')">Reset PW</button>
        </td>`;
        userListBody.appendChild(tr);
      });
    });
  }

  window.resetPass=(u)=>{const p=prompt("New password for "+u); if(p) db.ref('users/'+u+'/password').set(p);};
  sendBroadcastBtn.onclick=()=>{
    const msg=broadcastInput.value.trim(); if(!msg) return;
    db.ref('broadcast').push({message:msg,sender:currentUser}); broadcastInput.value=''; alert('Broadcast sent!');
  };
</script>
</body>
</html>
