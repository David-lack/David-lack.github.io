<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Maths Battle Arena</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
  body {margin:0;padding:0;font-family:'Segoe UI',Arial,sans-serif;background:#a3c4f3;min-height:100vh;display:flex;flex-direction:column;align-items:center;}
  .card{background:rgba(255,255,255,0.05);box-shadow:0 8px 32px rgba(0,0,0,0.15);border-radius:16px;padding:24px;margin:16px;width:360px;max-width:95vw;display:flex;flex-direction:column;align-items:center;}
  h1,h2{color:#ffd700;text-shadow:0 1px 4px #222;margin-bottom:12px;}
  input,button,select{margin:6px 0;padding:10px;font-size:1em;border-radius:6px;border:1px solid #888;background:#4b6cb7;color:#ffd700;width:100%;max-width:280px;box-sizing:border-box;}
  button{font-weight:bold;cursor:pointer;transition:0.2s;}
  button:hover{background:#354f7a;color:#ffd700;}
  .hidden{display:none !important;}
  .bars{display:flex;justify-content:space-between;gap:12px;width:100%;margin:8px 0;}
  .bar{flex:1 1 0;display:flex;flex-direction:column;align-items:center;}
  .bar-bg{background:#222c;width:100%;overflow:hidden;border-radius:8px;margin-top:3px;}
  #player-health,#npc-health{height:16px;border-radius:8px;transition:width 0.33s;}
  #player-health{background:linear-gradient(90deg,#e74c3c 0%,#f1c40f 100%);}
  #npc-health{background:linear-gradient(90deg,#3498db 0%,#8e44ad 100%);}
  #math-problem{font-size:1.2em;margin:10px 0;color:#fff;background:#232526;border-radius:8px;padding:10px;text-align:center;}
  table{width:100%;color:#ffd700;border-collapse:collapse;margin-top:10px;}
  th,td{border:1px solid #888;padding:6px;text-align:center;}
  th{background:#2c3e50;}
  .blur-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);backdrop-filter:blur(4px);display:flex;align-items:center;justify-content:center;color:#ffd700;font-size:1.5em;z-index:9999;display:none;}
  #sound-controls{display:flex;flex-direction:column;align-items:center;margin:8px 0;}
  .password-wrapper{position:relative;width:100%;max-width:280px;}
  .toggle-eye{position:absolute;right:10px;top:10px;cursor:pointer;width:24px;height:24px;}
  #broadcast-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);display:flex;align-items:center;justify-content:center;color:#ffd700;font-size:2em;z-index:999;display:none;}
</style>
</head>
<body>

<div id="broadcast-overlay"></div>

<div id="auth-section" class="card">
  <h1>Maths Battle Arena</h1>
  <button id="show-signin">Sign In</button>
  <button id="show-signup">Create Account</button>

  <form id="signin-form" class="hidden" onsubmit="return false;">
    <input type="text" id="signin-username" placeholder="Username" style="color:white;">
    <div class="password-wrapper">
      <input type="password" id="signin-password" placeholder="Password" style="color:white;">
      <img id="toggle-eye-signin" src="https://cdn-icons-png.flaticon.com/512/159/159604.png" class="toggle-eye">
    </div>
    <label style="color:white;"><input type="checkbox" id="remember-me"> Remember Me</label>
    <button id="signin-btn">Sign In</button>
    <div id="signin-error" style="color:red"></div>
  </form>

  <form id="signup-form" class="hidden" onsubmit="return false;">
    <input type="text" id="signup-username" placeholder="Username" style="color:white;">
    <div class="password-wrapper">
      <input type="password" id="signup-password" placeholder="Password" style="color:white;">
      <img id="toggle-eye-signup" src="https://cdn-icons-png.flaticon.com/512/159/159604.png" class="toggle-eye">
    </div>
    <button id="signup-btn">Create Account</button>
    <div id="signup-error" style="color:red"></div>
  </form>
</div>

<div id="game-section" class="card hidden">
  <h2 id="welcome-user"></h2>
  <div class="bars">
    <div class="bar"><span>Player</span><div class="bar-bg"><div id="player-health"></div></div></div>
    <div class="bar"><span>NPC</span><div class="bar-bg"><div id="npc-health"></div></div></div>
  </div>
  <div id="math-problem"></div>
  <input type="text" id="answer-input" placeholder="Your Answer" style="color:white;">
  <button id="submit-answer">Submit Answer</button>
  <div id="game-message"></div>
  <select id="difficulty-select">
    <option value="easy">Easy</option>
    <option value="medium">Medium</option>
    <option value="hard">Hard</option>
  </select>
  <button id="start-battle">Start Battle</button>
  <button id="logout-btn">Logout</button>
  <div id="admin-placeholder"></div>
  <div id="leaderboard"></div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script>
const firebaseConfig = {
  apiKey: "AIzaSyC2PqmEQE5JnupeQkhGJ_kWVts80eWtnUA",
  authDomain: "pizza-f6116.firebaseapp.com",
  databaseURL: "https://pizza-f6116-default-rtdb.firebaseio.com",
  projectId: "pizza-f6116",
  storageBucket: "pizza-f6116.appspot.com",
  messagingSenderId: "219234227309",
  appId: "1:219234227309:web:d4dc436930ad9b9898db64"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

const authSection=document.getElementById('auth-section');
const signinForm=document.getElementById('signin-form');
const signupForm=document.getElementById('signup-form');
const signinError=document.getElementById('signin-error');
const signupError=document.getElementById('signup-error');
const gameSection=document.getElementById('game-section');
const welcomeUserEl=document.getElementById('welcome-user');
const playerHealthEl=document.getElementById('player-health');
const npcHealthEl=document.getElementById('npc-health');
const mathProblem=document.getElementById('math-problem');
const answerInput=document.getElementById('answer-input');
const submitAnswerBtn=document.getElementById('submit-answer');
const gameMessage=document.getElementById('game-message');
const adminPlaceholder=document.getElementById('admin-placeholder');
const leaderboardDiv=document.getElementById('leaderboard');
const difficultySelect=document.getElementById('difficulty-select');
const startBattleBtn=document.getElementById('start-battle');
const broadcastOverlay=document.getElementById('broadcast-overlay');

const showSigninBtn=document.getElementById('show-signin');
const showSignupBtn=document.getElementById('show-signup');
const signinBtn=document.getElementById('signin-btn');
const signupBtn=document.getElementById('signup-btn');
const logoutBtn=document.getElementById('logout-btn');

const toggleSigninEye=document.getElementById('toggle-eye-signin');
const signinPassInput=document.getElementById('signin-password');
const toggleSignupEye=document.getElementById('toggle-eye-signup');
const signupPassInput=document.getElementById('signup-password');

let currentUser=null;
let playerHealth=100;
let npcHealth=100;
let currentAnswer=null;
let score=0;

broadcastOverlay.style.display = 'none';

function setupEyeToggle(input,img){
  img.addEventListener('click',()=>{
    input.type=input.type==='password'?'text':'password';
    img.src=input.type==='password'?"https://cdn-icons-png.flaticon.com/512/159/159604.png":"https://cdn-icons-png.flaticon.com/512/159/159605.png";
  });
}
setupEyeToggle(signinPassInput,toggleSigninEye);
setupEyeToggle(signupPassInput,toggleSignupEye);

showSigninBtn.addEventListener('click',()=>{signinForm.classList.remove('hidden');signupForm.classList.add('hidden');signinError.textContent='';signupError.textContent='';});
showSignupBtn.addEventListener('click',()=>{signupForm.classList.remove('hidden');signinForm.classList.add('hidden');signinError.textContent='';signupError.textContent='';});

function updateHealthBars(){
  playerHealthEl.style.width=Math.max(0,Math.min(100,playerHealth))+'%';
  npcHealthEl.style.width=Math.max(0,Math.min(100,npcHealth))+'%';
}

function generateProblem(){
  const diff=difficultySelect.value;
  if(diff==='easy'){
    const a=Math.floor(Math.random()*10)+1;
    const b=Math.floor(Math.random()*10)+1;
    const op=['+','-','*'][Math.floor(Math.random()*3)];
    currentAnswer=eval(`${a}${op}${b}`);
    mathProblem.textContent=`${a} ${op} ${b} = ?`;
  } else if(diff==='medium'){
    const a=Math.floor(Math.random()*50)+1;
    const b=Math.floor(Math.random()*50)+1;
    const op=['+','-','*'][Math.floor(Math.random()*3)];
    currentAnswer=eval(`${a}${op}${b}`);
    mathProblem.textContent=`${a} ${op} ${b} = ?`;
  } else {
    if(Math.random()<0.5){
      const x=Math.floor(Math.random()*10)+1;
      const c=Math.floor(Math.random()*10)+1;
      currentAnswer=x;
      mathProblem.textContent=`x + ${c} = ${x+c}, solve x`;
    } else {
      const n=Math.floor(Math.random()*10)+1;
      currentAnswer=2*n;
      mathProblem.textContent=`d/dx of x^2 + ${n} = ?`;
    }
  }
}

function updateLeaderboard(){
  db.ref('leaderboard').orderByChild('score').limitToLast(10).on('value',snapshot=>{
    if(snapshot.exists()){
      let entries=Object.entries(snapshot.val()).sort((a,b)=>b[1].score-a[1].score);
      let html='<table><tr><th>User</th><th>Score</th></tr>';
      entries.forEach(e=>{html+=`<tr><td>${e[0]}</td><td>${e[1].score}</td></tr>`;});
      html+='</table>';
      leaderboardDiv.innerHTML=html;
    } else {
      leaderboardDiv.innerHTML="No one on top. Become the First one!";
    }
  });
}

function saveScore(){if(!currentUser) return; db.ref('leaderboard/'+currentUser).set({score:score});}

db.ref('broadcast/latest').on('value', snapshot => {
  const msg = snapshot.val() || '';
  if(currentUser === 'David_lack' && msg.trim() !== ''){
    broadcastOverlay.textContent = msg;
    broadcastOverlay.style.display = 'flex';
    setTimeout(() => { broadcastOverlay.style.display = 'none'; }, 5000);
  } else {
    broadcastOverlay.style.display = 'none';
  }
});

startBattleBtn.addEventListener('click',()=>{
  playerHealth=100; npcHealth=100; score=0;
  updateHealthBars();
  generateProblem();
  submitAnswerBtn.disabled=false;
  answerInput.value='';
  gameMessage.textContent='';
});

submitAnswerBtn.addEventListener('click',()=>{
  const a=parseFloat(answerInput.value);
  if(isNaN(a)){gameMessage.textContent="Enter a valid number"; return;}
  // PLAYER TURN
  if(a===currentAnswer){npcHealth-=10; score+=10; gameMessage.textContent="Correct! NPC hit! You gained 10 points.";}
  else{if(Math.random()<0.7){playerHealth-=10; gameMessage.textContent="Wrong! NPC hit you!";} else{gameMessage.textContent="Wrong! NPC missed!";}}
  updateHealthBars();
  if(playerHealth<=0){gameMessage.textContent="You lost!"; submitAnswerBtn.disabled=true; saveScore(); return;}
  if(npcHealth<=0){gameMessage.textContent="You won!"; submitAnswerBtn.disabled=true; saveScore(); return;}
  // NPC TURN
  let npcGuessedCorrect=Math.random()<0.5;
  if(npcGuessedCorrect){playerHealth-=10; gameMessage.textContent+="\nNPC answered correctly! You lose 10 HP.";}
  else{npcHealth-=10; score+=5; gameMessage.textContent+="\nNPC answered wrong! NPC loses 10 HP.";}
  updateHealthBars();
  if(playerHealth<=0){gameMessage.textContent="You lost!"; submitAnswerBtn.disabled=true; saveScore(); return;}
  if(npcHealth<=0){gameMessage.textContent="You won!"; submitAnswerBtn.disabled=true; saveScore(); return;}
  generateProblem(); answerInput.value='';
});

function showGameFor(username){
  currentUser=username;
  authSection.classList.add('hidden');
  gameSection.classList.remove('hidden');
  welcomeUserEl.textContent=`Welcome, ${username}!`;
  updateLeaderboard();
  if(username==='David_lack') installAdminPanel();
}

window.addEventListener('load',()=>{
  const rememberedUser=localStorage.getItem('rememberedUser');
  if(rememberedUser){
    db.ref('users/'+rememberedUser).get().then(snapshot=>{
      if(snapshot.exists()) showGameFor(rememberedUser);
    });
  }
});

signinBtn.addEventListener('click',()=>{
  const username=document.getElementById('signin-username').value.trim();
  const password=document.getElementById('signin-password').value.trim();
  const rememberMe=document.getElementById('remember-me').checked;
  signinError.textContent='';
  if(!username||!password){signinError.textContent="Enter username & password"; return;}
  db.ref('users/'+username).get().then(snapshot=>{
    if(snapshot.exists() && snapshot.val().password===password){
      if(rememberMe) localStorage.setItem('rememberedUser', username);
      showGameFor(username);
    } else signinError.textContent="Wrong username/password";
  });
});

signupBtn.addEventListener('click',()=>{
  const username=document.getElementById('signup-username').value.trim();
  const password=document.getElementById('signup-password').value.trim();
  signupError.textContent='';
  if(!username||!password){signupError.textContent="Enter username & password"; return;}
  db.ref('users/'+username).get().then(snapshot=>{
    if(snapshot.exists()){signupError.textContent="Username exists"; return;}
    return db.ref('users/'+username).set({password:password});
  }).then(()=> showGameFor(username)).catch(err=>{signupError.textContent="Signup failed";});
});

logoutBtn.addEventListener('click',()=>{
  currentUser=null;
  localStorage.removeItem('rememberedUser');
  gameSection.classList.add('hidden');
  authSection.classList.remove('hidden');
  signinForm.classList.remove('hidden');
  signupForm.classList.add('hidden');
});

function installAdminPanel(){
  if(currentUser!=='David_lack') return; // ONLY OWNER
  adminPlaceholder.innerHTML='';
  const panel=document.createElement('div');
  panel.id='admin-panel';
  panel.innerHTML=`
    <div style="font-weight:bold;color:#ffd700;margin-bottom:6px;">Admin Panel (Owner)</div>
    <button id="reset-leaderboard">Reset Leaderboard</button>
    <div style="margin-top:8px;">
      <input type="text" id="broadcast-input" placeholder="Type broadcast message" style="width:80%;padding:6px;margin-bottom:4px;">
      <button id="send-broadcast">Send Broadcast</button>
    </div>
    <div style="margin-top:12px;">
      <h3 style="color:#ffd700;">All Accounts</h3>
      <table id="all-accounts-table" style="width:100%;color:#ffd700;border-collapse:collapse;">
        <tr><th>Username</th><th>Password</th><th>Action</th></tr>
      </table>
    </div>
  `;
  adminPlaceholder.appendChild(panel);

  document.getElementById('reset-leaderboard').addEventListener('click',()=>{
    if(confirm('Reset leaderboard?')) db.ref('leaderboard').remove();
  });
  document.getElementById('send-broadcast').addEventListener('click',()=>{
    const msg=document.getElementById('broadcast-input').value.trim();
    if(!msg) return;
    db.ref('broadcast/latest').set(msg);
    document.getElementById('broadcast-input').value='';
  });

  const accountsTable=document.getElementById('all-accounts-table');
  db.ref('users').on('value', snapshot=>{
    accountsTable.innerHTML='<tr><th>Username</th><th>Password</th><th>Action</th></tr>';
    snapshot.forEach(child=>{
      const username=child.key;
      const password=child.val().password;
      const row=document.createElement('tr');
      row.innerHTML=`<td>${username}</td><td>${password}</td><td><button class="delete-account-btn" data-user="${username}">Delete</button></td>`;
      accountsTable.appendChild(row);
    });
    document.querySelectorAll('.delete-account-btn').forEach(btn=>{
      btn.addEventListener('click',()=>{
        const userToDelete=btn.dataset.user;
        if(confirm(`Delete account: ${userToDelete}?`)){
          db.ref('users/'+userToDelete).remove();
          db.ref('leaderboard/'+userToDelete).remove();
        }
      });
    });
  });
}
</script>
</body>
</html>
